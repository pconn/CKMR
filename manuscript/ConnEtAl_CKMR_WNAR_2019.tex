\documentclass[serif,mathserif]{beamer}
\usepackage{amsmath, amsfonts, epsfig, xspace, color, colortbl,natbib,xcolor}
\usepackage{algorithm,algorithmic}
\usepackage{animate}
%\usepackage{pstricks,pst-node}
%\usepackage{multimedia}
%\usepackage{movie15}
\usepackage[normal,tight,center]{subfigure}
\setlength{\subfigcapskip}{-.5em}
%\usepackage{beamerthemesplit}
%\usetheme{lankton-keynote}

%%%
% PRELIMINARY FORMATTING
%%%
\renewcommand\sfdefault{phv}
\renewcommand\familydefault{\sfdefault}
\usetheme{default}
\usepackage{color}
\useoutertheme{default}
\usepackage{texnansi}
\usepackage{marvosym}
\definecolor{bottomcolour}{rgb}{0.32,0.3,0.38}
\definecolor{middlecolour}{rgb}{0.08,0.08,0.16}
\definecolor{noaaturq}{RGB}{2,171,216}
\definecolor{noaablue}{RGB}{20,21,127}
\setbeamerfont{title}{size=\huge}
\setbeamercolor{structure}{fg=gray}
\setbeamertemplate{frametitle}[default]%[center]
\setbeamercolor{normal text}{bg=black, fg=white}
\setbeamercolor{block title}{parent=normal text, bg=noaaturq}%noaablue!60!white}
\setbeamercolor{block body}{parent=normal text, use=block title,bg=noaablue}%block title.bg!50!black}
\setbeamertemplate{background canvas}[vertical shading]
[bottom=bottomcolour, middle=middlecolour, top=black]
\setbeamertemplate{items}[circle]
\setbeamerfont{frametitle}{size=\huge}
\setbeamertemplate{navigation symbols}{} %no nav symbols
\setbeamertemplate{blocks}[rounded]
\graphicspath{{c:/users/paul.conn/git/STabundance/ISEC_presentation}}

%\usecolortheme{seahorse}


\begin{document}

\def\VAR{{\rm Var}\,}
\def\COV{{\rm Cov}\,}
\def\Prob{{\rm P}\,}
\def\bfX{\bf X}
\def\bfz{{\bf z}}
\def\bfbeta{\boldsymbol{\beta}}
\def\bfdelta{\boldsymbol{\delta}}
\def\bfeta{\boldsymbol{\eta}}
\def\bfnu{\boldsymbol{\nu}}
\def\bfmu{\boldsymbol{\mu}}
\def\bfphi{\boldgreek{\phi}}
\def\bfx{\bf x}

\frame{
\centering
\renewcommand{\baselinestretch}{1.8}\normalsize
{\LARGE \textcolor{noaaturq}{Close-kin mark-recapture in dispersal limited populations}}\\
\bigskip\bigskip
\renewcommand{\baselinestretch}{1.25}\normalsize
Paul B. Conn\\
\footnotesize \textcolor{lightgray}{\em Marine Mammal Lab, NOAA Alaska Fisheries Science Center, Seattle, WA }\\
\textcolor{lightgray}{Email: paul.conn@noaa.gov}\\
\bigskip\bigskip
\textcolor{lightgray}{WNAR meeting\\
Portland, Oregon\\
June 26, 2019}\\	
\vspace*{\fill}
\begin{figure}
%	%\subfigure{\includegraphics[height=2cm]{UAFlogo.png}}
%	\hspace*{\fill}
%	\subfigure{\includegraphics[height=2cm]{noaa_logo.png}}
\hspace{\fill}
\includegraphics[height=1.5cm]{NOAA-logo.pdf}
\end{figure}
}

\section{Background} % add these to see outline in slides
\begin{frame}
\frametitle{Outline}
  \begin{enumerate}
    \item CKMR: A brief introduction \pause
    \item Canonical inference \pause
    \item Assumption violations: dispersal limitation \pause
    \item Spatially structured simulation study \pause
    \item Earth-shattering conclusions
  \end{enumerate}
\end{frame}

\section{Background} % add these to see outline in slides
\begin{frame}
\frametitle{CKMR}
  \textcolor{noaaturq}{\textbf{What is close-kin mark-recapture (CKMR)?}} \\ \pause
  A framework for estimating abundance and demography based on the frequency of
  kinship relationships (e.g., parent-offspring, half siblings) observed in (tissue) samples of fish and wildlife populations
  \pause
  \begin{enumerate}
    \item Genotype samples
    \item Determine kin relationships (``kinference")
    \item Conduct statistical inference
  \end{enumerate}
\end{frame}

\section{Background} % add these to see outline in slides
\begin{frame}
\frametitle{CKMR}
  \textcolor{noaaturq}{Cartoon example: parent-offspring analysis in same year (from \citet{BravingtonEtAl2016})} \\
  \begin{columns}[c]
  \column{2.4in}
    \begin{itemize}
      \item Out of a population of $N_J=9$ juveniles and $N_A = 16$ adults, $n_j=4$ juveniles and
        $n_A =6$ adults are sampled.
      \item Each juvenile `marks' 2 parents
      \item Each juvenile compared to each adult
      \item $H = 3$ parent-offspring relationships observed
    \end{itemize}
    \column{1.6in}
  \framebox{\includegraphics[width=1.6in]{CKMR_LP_fish.jpg}}
  \end{columns}
\end{frame}

\section{Background} % add these to see outline in slides
\begin{frame}
\frametitle{CKMR}
  \textcolor{noaaturq}{Cartoon example: parent-offspring analysis in same year (from \citet{BravingtonEtAl2016})}
  \begin{columns}[c]
  \column{2.4in}
    \begin{itemize}
      \item Number of comparisons: $n_j n_a$
      \item Probability of ``success" = $2/N_A$
      \item Lincoln-Petersen type estimator: $\hat{N_A} = 2 n_J n_A / H = 16$.
    \end{itemize}
    \column{1.6in}
  \framebox{\includegraphics[width=1.6in]{CKMR_LP_fish.jpg}}
  \end{columns} \pause
  \vspace{0.5cm}
  \textcolor{noaaturq}{\huge $\rightarrow$ Amazing!}
\end{frame}

\section{Background} % add these to see outline in slides
\begin{frame}
\frametitle{CKMR}
  \textcolor{noaaturq}{Cartoon example: parent-offspring analysis in same year (from \citet{BravingtonEtAl2016})}
  \begin{columns}[c]
  \column{2.4in}
    \begin{itemize}
      \item Number of comparisons: $n_j n_a$
      \item Probability of ``success" = $2/N_A$
      \item Lincoln-Petersen type estimator: $\hat{N_A} = 2 n_J n_A / H = 16$.
    \end{itemize}
    \column{1.6in}
  \framebox{\includegraphics[width=1.6in]{CKMR_LP_fish.jpg}}
  \end{columns} \pause
  \vspace{0.5cm}
  \textcolor{noaaturq}{\huge $\rightarrow$ Amazing!}
\end{frame}

\section{Background} % add these to see outline in slides
\begin{frame}
\frametitle{CKMR}
  Lincoln-Petersen type estimators have been applied to estimate abundance of spawning Chinook salmon in the Columbia river...
  \vspace{0.5cm}

  \framebox{\includegraphics[width=3in]{RawdingScreenshot.jpg}}

  \vspace{0.5cm}
  but the idea is considerably more broad!
\end{frame}

\section{Inference} % add these to see outline in slides
\begin{frame}
\frametitle{Canonical inference}
\textcolor{noaaturq}{Maximum pseudo-likelihood \citep{BravingtonEtAl2016}}

More generally (e.g. with data spanning multiple ages, years and sexes) we can base inference on

 \begin{equation*}
     L = \prod_i \prod_{j>i} \prod_k P_{ijk}^{y_{ijk}} (1-P_{ijk})^{(1-y_{ijk})},
     \label{eq:likelihood}
 \end{equation*}
where
\begin{itemize}
  \item $i$ indicates animal 1,
  \item $j$ indicates animal 2,
  \item $k$ indicates a particular kinship relationship
  \item $P_{ijk}$ is probability of a kinship match
  \item $y_{ijk}$ is a match indicator
\end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Canonical inference}
  \textcolor{noaaturq}{$P_{ijk}$ for Parent-offspring pairs}

  \vspace{0.5cm}

  \citet{BravingtonEtAl2016} introduced the concept of relative reproductive output for formulating CKMR probabilities.  Assuming accurate aging info, and ordering animals so that $b_i<b_j$,

  \begin{equation*}
   P_{ij1} = \frac{E[R_i(b_j)|\bfz_i,\bfz_j]}{E[R_+(b_j)|\bfz_j]},
  \end{equation*}
  \begin{itemize}
    \item $\bfz_i,\bfz_j$ are covariate vectors for animals $i$ and $j$ (sex, age, etc.)
    \item $R_i(b_j)$ is reproductive output of animal $i$ in $b_j$, the year of $j$'s birth.
    \item $R_+(b_j)$ is total reproductive output of the population in year $b_j$
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Canonical inference}
  \textcolor{noaaturq}{$P_{ijk}$ for Parent-offspring pairs}

  \vspace{0.5cm}

  If all adults have same reproductive output, this is simply

  \begin{eqnarray*}
   P_{ij1} &  = & 2/N_A(b_j),
  \end{eqnarray*}

  \vspace{.5cm}

  where $N_A(b_j)$ is the number of adults in year $b_j$.
  Typically, separate calculations would be made for males and female parents,
  so we might include sex subscripts on things...

\end{frame}

\begin{frame}
  \frametitle{Canonical inference}
  \textcolor{noaaturq}{$P_{ijk}$ for Half-sibling pairs}

  \vspace{0.5cm}
  Again ordering comparisons so that $b_i < b_j$ (and suppressing covariate dependence and expected value notation)

  \begin{equation*}
  P_{ij2} = \sum_{d}  \frac{R_d(b_i)}{R_+(b_i)} \frac{R_d(b_j)}{R_+(b_j)}
  \label{eq:halfsib}
  \end{equation*}

  If all adults are the same in terms of reproductive status this is simply
   \begin{equation*}
  P_{ij2} = \frac{\phi_{b_i \rightarrow b_j}}{N_A(b_j)}
  \label{eq:halfsib}
  \end{equation*}
\end{frame}


\begin{frame}
\frametitle{CKMR Assumptions}
\begin{itemize}
  \item Accurate genotyping
  \item No heterogeneity in kinship probabilities that can't be explained by observed (or inferred)
        covariates \pause
  \item Population and sampling model is accurate \pause
  \item Population is randomly sampled
       \begin{enumerate}
         \item Complete mixing -or-
         \item Random sampling
       \end{enumerate}
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{CKMR Assumptions}
\begin{itemize}
  \item No heterogeneity in kinship probabilities that can't be explained by observed (or inferred)
        covariates

  \item Population and sampling model is accurate

  \item \bf Population is randomly sampled
       \begin{enumerate}
         \item Complete mixing -or-
         \item Random sampling
       \end{enumerate}
       \rm
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Checks for complete mixing}
Check 1: Visual checks using genetics and auxiliary data (e.g., telemetry)

\vspace{0.5cm}

  \framebox{\includegraphics[width=4in]{white_shark_connectivity.jpg}}
  \citet{HillaryEtAl2018}
\end{frame}

\begin{frame}
\frametitle{Checks for complete mixing}
  \begin{columns}[c]
  \column{2in}
   Check 2: Formal tests of distribution

   \vspace{1cm}
   Observation: We can learn about dispersal from genetic relatedness data, but dispersal has largely not yet been integrated into CKMR estimation models
  \column{2in}
  \framebox{\includegraphics[width=1.5in]{distance_fig.pdf}}
  \end{columns}
\end{frame}

\begin{frame}
\frametitle{Checks for complete mixing}
  \begin{columns}[c]
  \column{2in}

  \textcolor{noaaturq}{Check for mixing passes}: Yay! Full speed ahead using opportunistically gathered genetic samples.

  \vspace{0.5cm}

  \textcolor{noaaturq}{Check for mixing fails}:  What then? Can I still use CKMR with opportunistically (and quite likely spatially biased) sampling?

    \column{2in}
  \framebox{\includegraphics[width=2in]{hunter_dist.jpg}}
  \citet{DiefenbachEtAl2005}
  \end{columns}

\end{frame}

\begin{frame}
\frametitle{Simulation study}
  \begin{columns}[c]
  \column{2in}
\begin{itemize}
  \item Individual based; keep track of relatives
  \item Abundance uniform on $10 \times 10$ grid
  \item Animals can only reproduce with each other if
  they are in same grid cell
  \item Demographic schedules $\approx$ bearded seals
\end{itemize}
  \column{2in}
  \colorbox{white}{\includegraphics[width=2in]{life_history.pdf}}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Simulation study}
  \begin{columns}[c]
  \column{2in}
\begin{itemize}
  \item Four dispersal scenarios: no dispersal, juvenile-only\textcolor{noaaturq}{$^\dag$}, all-ages\textcolor{noaaturq}{$^\dag$}, complete mixing
  \item Total population size $\approx 10,000$
  \item Simulations run for 60 years, 100 individuals sampled per year in years 41-60
  \item 4 sampling scenarios
\end{itemize}
     \textcolor{noaaturq}{$^\dag$ discretized normal kernel with $\sigma=1.0$ grid cell}
  \column{2in}
  \colorbox{white}{\includegraphics[width=2in]{sampling_fig2.pdf}}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Simulation study}
\textcolor{noaaturq}{Pseudo-likelihood}

(Non-spatial) pseudo-likelihood probabilities calculated as function of underlying population model.

\begin{itemize}
\item $N_{a,t,g}$: Number of age $a$, sex $g$ individuals alive at time $t$
\item $N_{0,t,g} = \exp (R_0)$
\item $N_{a,1,g} = N_{a-1,1,g} S_a$ for $a>0$ (stable age structure at time $t=1$)
\item $N_{0,t,g} = 0.5 \sum_a N_{a,t,1} f_{a,1}$ for $t>1$ (fecundity $f_{a,g}$)
\item $N_{a,t,g} = N_{a-1,t-1,g} S_{a-1}$
\item $S_a$ = Reduced Additive Weibull$(a ; \eta_1,\eta_2,\eta_3)$,
\item $f_{a,g} = [1+\exp(-\kappa_g (a - \alpha_g))]$  (logistic function)
\item Parameters: $\boldsymbol{\theta} = \{ R_0, \eta_1, \eta_2, \eta_3, k_1, k_2,\alpha_1,\alpha_2 \}$.
\end{itemize}
\end{frame}


\begin{frame}
\frametitle{Simulation study}
\begin{columns}
\column{\dimexpr\paperwidth-10pt}
\textcolor{noaaturq}{Pseudo-likelihood}
\footnotesize

Parent-offspring probabilities
\begin{equation*}
  P_{b_1,y_1,b_2,g} =
  \left\{ \begin{array}{ll}
    \frac{f_{y_1-b_1-1,g}}{\sum_a N_{a,b_2,g} f_{a-1,g}} & \text{if } y_1>b_2, b_1 < y_1 \le (b_1+37), \text{ and } y_1 \le (b_2+37) \\
    0  & \text{otherwise}.
  \end{array} \right\}
\end{equation*}

Half-sib probabilities
\begin{equation*}
  P_{b_1,b_2,g}^\prime = \sum_a N_{a,b_1,g} \frac{f_{a-1,g}}{\sum_{a^\prime} N_{a^\prime,b_1,g}f_{a^\prime-1,g}} \left( \prod_{y=b_1}^{b_2-1} S_{a+y-b_1} \right) \frac{f_{a+b_2-b_1-1,g}}{\sum_{a^\prime} N_{a^\prime,b_2,g}f_{a^\prime-1,g}}.
  \label{eq:halfsib}
\end{equation*}

Negative joint log pseudo-likelihood (Poisson approx)
\begin{eqnarray*}
     \Lambda & = & \sum_{b_1} \sum_{y_1} \sum_{b_2} \sum_g m_{b_1,y_1,b_2,g} \log(n_{b_1,y_1,b_2,g} P_{b_1,y_1,b_2,g}) - n_{b_1,y_1,b_2,g} P_{b_1,y_1,b_2,g} + \\
     & & \sum_{b_1} \sum_{b_2} \sum_g m_{b_1,b_2,g}^\prime \log(n_{b_1,b_2,g}^\prime P_{b_1,b_2,g}^\prime) - n_{b_1,b_2,g}^\prime P_{b_1,b_2,g}^\prime - \\
     & & \sum_{i=1}^3  (2 \sigma_{\eta,i}^2)^{-1} (\eta_i - \mu_{\eta,i})^2 - \sum_{i=1}^2  (2 \sigma_{\kappa,i}^2)^{-1} (\kappa_i - \mu_{\kappa,i})^2 - \sum_{i=1}^2  (2 \sigma_{\alpha,i}^2)^{-1} (\alpha_i - \mu_{\alpha,i})^2
\end{eqnarray*}

\end{columns}
\end{frame}

\begin{frame}
\frametitle{Simulation study}
\textcolor{noaaturq}{Computing}
\begin{itemize}
\item Joint negative log pseudo-likelihood minimized using \texttt{nlminb} function in R \pause
\item Log-likelihood coded in C++ and linked to R via the ADT package which allows automatic differentiation from Tapenade libraries \pause
\item 100 simulations per design point (4 movement scenarios, 4 sampling scenarios)
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Results - Abundance}
  \colorbox{white}{\includegraphics[width=3in]{BiasN_fec.pdf}}
\end{frame}

\begin{frame}
\frametitle{Results - Adult survival}
  \begin{columns}[c]
  \column{2.5in}
  \colorbox{white}{\includegraphics[width=2.5in]{S_results.pdf}}
  \column{1.5in}
   \begin{itemize}
   \item Relatively unbiased at `high sample size' ages in all scenarios \textit{except} with adult dispersal and refugia scenario (adults emigrating from sampled area confounded with survival)
   \item Mean ``posterior" SE to ``prior" SD ratios: 0.47, 0.81, 0.37 
   \end{itemize}
  \end{columns}
\end{frame}

\begin{frame}
\frametitle{Results - Fecundity}
  \begin{columns}[c]
  \column{2.5in}
  \colorbox{white}{\includegraphics[width=2.5in]{Fec_results.pdf}}
       \column{1.5in}
    \begin{itemize}
   \item Generally unbiased
   \item Mean ``posterior" SE to ``prior" SD ratios: 0.79, 0.83, 1.17, 0.76 
   \end{itemize}
   \end{columns}
\end{frame}

\begin{frame}
\frametitle{Summary}
 \begin{itemize}
   \item CKMR an exciting new approach for estimating abundance and demography using opportunistically collected genetic data; high profile applications (southern bluefin tuna, white sharks, salmon) but potential for many more (esp in exploited populations) \pause
   \item Inference appears to be moderately robust to dispersal limitation when there is moderate spatial bias in sampling probability (but not extreme bias!)  \pause
    \item Needs to be examined on a case-by-case basis; individual based simulation useful in that regard \pause
   \item Potential for quantifying dispersal rates by integrating sampling location into future modeling efforts
  \end{itemize}
\end{frame}

 \section{End notes}
  \begin{frame}
  \frametitle{}
  {\Huge Questions?}

  \vspace{0.5cm}

  \textcolor{noaaturq}{Acknowledgments} \\
  \begin{itemize}
  \item Coauthors: Mark Bravington, Jay Ver Hoef
  \item Individual-based simulation code adapted from \texttt{fishsim} code by Shane Baylis
  \item Mark Bravington, Paavo Jumppanen: Development and software assist with configuring \texttt{ADT} R package to work with Tapenade autodiff libraries and Visual C++
  \end{itemize}
  \vspace{0.5cm}
   \textcolor{noaaturq}{References}
 \bibliographystyle{plainnat}
 {\tiny
  \bibliography{master_bib}}

 \end{frame}



\end{document}
